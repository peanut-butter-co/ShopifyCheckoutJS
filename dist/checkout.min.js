class NotValidFieldException extends Error{constructor(e){super(e+" does not have a valid Shopify field element as parent."),this.name="NotValidFieldException"}}class NotImplementedError extends Error{constructor(e){let t=`The method ${(new Error).stack.split("\n")[2].replace(" at ","")} isn't implemented.`;e&&(t+=` Message: "${e}".`),super(t)}}class SelectionMethod extends HTMLDivElement{constructor(e){if(!(e instanceof HTMLDivElement&&e.classList.contains("radio-wrapper")))throw TypeError("Not a radio-wrapper");return Object.setPrototypeOf(e,SelectionMethod.prototype),Object.assign(e,{type:"generic"})}addDescription(e){throw new NotImplementedError}get input(){let e=this.querySelector("input");return e||Error(`No input found for the ${this.type} method`)}get methodData(){return this.input.dataset}get methodId(){return this.input.id}get checked(){return this.input.checked}set checked(e){this.input.checked=e}}class ShippingMethod extends SelectionMethod{constructor(e){super(e),Object.setPrototypeOf(this,ShippingMethod.prototype),this.type="shipping",this.addEventListener("change",()=>{let e=new CustomEvent("checkout:shippingmethod:changed",{detail:this});document.dispatchEvent(e)})}addDescription(e){let t=this.querySelector(".radio__label__primary"),s=document.createElement("span");s.classList.add("small-text"),s.innerHTML=e,t.appendChild(document.createElement("br")),t.appendChild(s)}get shippingRate(){return this.methodData.checkoutTotalShippingCents/100}get subtotalPrice(){return this.methodData.checkoutSubtotalPriceCents/100}}class PaymentMethod extends SelectionMethod{constructor(e){if(!e.dataset.selectGateway)throw new NotValidFieldException;super(e),Object.setPrototypeOf(this,PaymentMethod.prototype),this.type="payment",this.addEventListener("change",()=>{let e=new CustomEvent("checkout:paymentmethod:changed",{detail:this});document.dispatchEvent(e)})}addDescription(e){this.nextElementSibling.querySelector(".blank-slate").innerHTML=e}get methodData(){return this.dataset}get gatewayId(){return this.dataset.selectGateway}get gatewayName(){return this.dataset.gatewayName}}class FieldRetriever{retrieve(e){let t=null;if([".field",".checkbox-wrapper"].some(s=>{if(t=e.closest(s),null!=t)return!0})){let e={};if(t.classList.contains("field"))e=t;else{e=document.createElement("div");let s=t.parentElement;e.classList.add("field"),e.appendChild(t),s.appendChild(e)}return this._setFieldPropierties(e),e}throw new NotValidFieldException}_setFieldPropierties(e){e.children&&(e.wrapperClass=e.children[0].classList[0])}}class Field extends HTMLDivElement{constructor(e){let t={input:'[id^="checkout_"]',errorMessage:".field__message--error",wrapper:".field__input-wrapper"},s={wrapper:["field__input-wrapper"],field:["field"],fieldInput:["field__input"],label:["field__label","field__label--visible"],fieldError:["field--error"],fieldErrorMessage:["field__message","field__message--error"]};if("string"==typeof e){let i=document.querySelector("#"+e),r=(new FieldRetriever).retrieve(i);return Object.setPrototypeOf(r,Field.prototype),Object.assign(r,{fieldName:r.name,fieldId:r.id,selectors:t,classes:s})}if("object"==typeof e){const{name:i,label:r=i}=e;let l="checkout_attributes_"+i,o=`checkout[attributes][${i}]`,d=document.createElement("div");d.classList.add(s.field);let n=document.createElement("div");n.classList.add(s.wrapper);let c=document.createElement("label");return c.classList.add(...s.label),c.innerText=r,c.htmlFor=l,n.appendChild(c),d.appendChild(n),Object.setPrototypeOf(d,Field.prototype),Object.assign(d,{fieldName:o,fieldId:l,selectors:t,classes:s})}}created(){let e=new CustomEvent("checkout:field:created",{detail:this});document.dispatchEvent(e)}addField(e){throw new NotImplementedError}showError(e){if(this.removeError(),this.classList.add(...this.classes.fieldError),e&&e.length>0){let t=document.createElement("p");t.classList.add(...this.classes.fieldErrorMessage),t.innerHTML=e,this.appendChild(t)}}removeError(){this.classList.remove(...this.classes.fieldError),this.querySelectorAll(this.selectors.errorMessage).forEach(e=>{e.remove()})}remove(){let e=new CustomEvent("checkout:field:removed",{detail:this});document.dispatchEvent(e),super.remove()}get value(){return this.querySelector(this.selectors.input).value}set value(e){this.querySelector(this.selectors.input).value=e}insertAfter(e){if(!(e&&e instanceof Field))throw TypeError("Object trying to add is not a Field element");this.insertAdjacentElement("afterend",e)}insertBefore(e){if(!(e&&e instanceof Field))throw TypeError("Object trying to add is not a Field element");this.insertAdjacentElement("beforebegin",e)}}class Tooltip extends HTMLDivElement{constructor(e,t,s="#question"){let i={wrapper:["field__icon","has-tooltip"],tooltip:["tooltip"],svgWrapper:["field__icon-svg"],svgIcon:["icon-svg","icon-svg--color-adaptive-lighter","icon-svg--size-16","icon-svg--block"]},r=document.createElement("div");r.setAttribute("role","tooltip"),r.classList.add(...i.wrapper);let l=document.createElement("span");l.id="tooltip-for-"+t,l.classList.add(...i.tooltip),l.innerText=e;let o=document.createElement("div");o.classList.add(...i.svgWrapper);let d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.classList.add(...i.svgIcon),d.setAttribute("role","presentation"),d.focusable="false";let n=document.createElementNS("http://www.w3.org/2000/svg","use");return n.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",s),n.setAttributeNS("http://www.w3.org/1999/xlink","href",s),d.appendChild(n),o.appendChild(d),r.appendChild(l),r.appendChild(o),r}}class TextField extends Field{constructor(e){super(e),Object.setPrototypeOf(this,TextField.prototype),"object"==typeof e&&this.addField(e),this.created()}addField(e){let t=document.createElement("input");t.classList.add(...this.classes.fieldInput),t.placeholder=e.placeholder?e.placeholder:"",t.size=e.size?e.size:30,t.type=e.type?e.type:"text",t.value=e.defaultValue?e.defaultValue:"",t.name=this.fieldName,t.id=this.fieldId,this.querySelector(this.selectors.wrapper).appendChild(t),"string"==typeof e.tooltip&&this.addTooltip(e.tooltip)}addTooltip(e="",t="#question"){this.removeTooltip();const s=this.querySelector(this.selectors.wrapper);s.classList.add("field__input-wrapper--icon-right");let i=new Tooltip(e,this.fieldId,t);s.appendChild(i)}removeTooltip(){const e=this.querySelector(this.selectors.wrapper),t=e.querySelectorAll(".field__icon");e.classList.remove("field__input-wrapper--icon-right"),t.forEach(e=>{e.remove()})}}class CheckboxField extends Field{constructor(e){let t={input:'input[type="checkbox"]',wrapper:".checkbox-wrapper"},s={label:["checkbox__label"],fieldInputWrapper:["checkbox__input"],fieldInput:["input-checkbox"],wrapper:["checkbox-wrapper"]};if("object"==typeof e){e.type="checkbox",super(e);let i=this.querySelector(this.selectors.wrapper);i.classList.remove(...i.classList),i.classList.add(...s.wrapper),Object.setPrototypeOf(this,CheckboxField.prototype),Object.assign(this.classes,s),Object.assign(this.selectors,t);let r="boolean"==typeof e.checked&&e.checked;this.addField(r)}else super(e),Object.setPrototypeOf(this,CheckboxField.prototype),Object.assign(this.classes,s),Object.assign(this.selectors,t);this.created()}addField(e){let t=this.querySelector(this.selectors.wrapper),s=t.querySelector("label");s.classList.remove(...s.classList),s.classList.add(...this.classes.label);let i=document.createElement("div");i.classList.add(...this.classes.fieldInputWrapper);let r=document.createElement("input");r.classList.add(...this.classes.fieldInput),r.type="checkbox",r.checked=e,r.name=this.fieldName,r.id=this.fieldId,i.appendChild(r),t.insertBefore(i,s)}get checked(){return this.querySelector(this.selectors.input).checked}set checked(e){this.querySelector(this.selectors.input).checked=e}}class DropdownField extends Field{constructor(e){super(e),Object.setPrototypeOf(this,DropdownField.prototype),Object.assign(this.classes,{field:["field","field--show-floating-label"],fieldInput:["field__input","field__input--select"],fieldInputWrapper:["field__input-wrapper","field__input-wrapper--select"],arrow:["field__caret","shown-if-js"],svgIcon:["icon-svg","icon-svg--color-adaptive-lighter","icon-svg--size-10","field__caret-svg"]}),"object"==typeof e&&this.addField(e),this.created()}addField(e){if(!e.options)throw new ReferenceError("No options defined for DropdownField");this.classList.add(...this.classes.field);const t=this.querySelector(this.selectors.wrapper);t.classList.add(...this.classes.fieldInputWrapper);let s=document.createElement("select");if(s.classList.add(...this.classes.fieldInput),s.placeholder=e.placeholder?e.placeholder:"",s.name=this.fieldName,s.id=this.fieldId,e.defaultValue){const t=document.createElement("option");t.disabled=!0,t.selected=!0,t.innerText=e.defaultValue,s.add(t),s.placeholder=e.placeholder?e.placeholder:e.defaultValue}e.options.forEach(e=>{let t=document.createElement("option");t.innerText=e.text,t.value=e.value,s.add(t)});let i=document.createElement("div");i.classList.add(...this.classes.arrow);let r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.classList.add(...this.classes.svgIcon),r.setAttribute("role","presentation"),r.focusable="false";let l=document.createElementNS("http://www.w3.org/2000/svg","use");l.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#caret-down"),l.setAttributeNS("http://www.w3.org/1999/xlink","href","#caret-down"),r.appendChild(l),i.appendChild(r),t.appendChild(s),t.appendChild(i)}}class FieldFactory{constructor(){}createFieldByElement(e){switch(e.type){case"text":case"email":case"tel":return new TextField(e.id);case"checkbox":return new CheckboxField(e.id);case"select-one":return new DropdownField(e.id);case"hidden":return null;default:try{return new Field(e.id)}catch(e){if(e instanceof NotValidFieldException)return null;throw e}}}}class Checkout{constructor(){this.Steps={INFORMATION:"contact_information",SHIPPING:"shipping_method",PAYMENT:"payment_method",PROCESSING:"processing",THANKYOU:"thank_you",ORDERSTATUS:"order_status",STOCK_PROBLEMS:"stock_problems"},this.selectors={inputs:"input[id], select[id]",selectionMethods:".section--{TYPE}-method .radio-wrapper",fields:'[id^="checkout_"]',stockProblem:{list:".stock-problem-table .product__description",name:".product__description__name",description:".product__description__variant"}},document.addEventListener("page:load",this._onLoad.bind(this),!1),document.addEventListener("page:change",this._onLoad.bind(this),!1),document.addEventListener("checkout:field:created",this._fieldCreated.bind(this),!1),document.addEventListener("checkout:field:removed",this._fieldRemoved.bind(this),!1),this.lastStep=this._getLastStep(),this.currentStep=this._getCurrentStep(),this.fields=[],this.fields=this._getFields()}_getFields(){let e=[];const t=document.querySelectorAll(this.selectors.inputs),s=new FieldFactory;return t.forEach(t=>{let i=s.createFieldByElement(t);null!=i&&(e[t.id]=i)}),e}_getLastStep(){let e=sessionStorage.getItem("step");if(null==e&&document.referrer){e=new URL(document.referrer).pathname}return e}_getCurrentStep(){let e=Shopify.Checkout.step;return"stock_problems"==Shopify.Checkout.page&&(e=this.Steps.STOCK_PROBLEMS),void 0!==Shopify.Checkout.OrderStatus&&(e="thank_you"==Shopify.Checkout.page?this.Steps.THANKYOU:this.Steps.ORDERSTATUS),sessionStorage.setItem("step",e),e}_triggerEvent(e,t={}){let s=new CustomEvent("checkout:"+e,{detail:t});document.dispatchEvent(s)}_getSelectionMethods(e){let t=document.querySelectorAll(this.selectors.selectionMethods.replace("{TYPE}",e)),s=[];return t.forEach(t=>{try{"shipping"==e?s.push(new ShippingMethod(t)):"payment"==e&&s.push(new PaymentMethod(t))}catch(e){if(!(e instanceof NotValidFieldException))throw e}}),s}_getStockProblemList(){let e=document.querySelectorAll(this.selectors.stockProblem.list),t=[];for(let s of e){let e=s.querySelector(this.selectors.stockProblem.name).innerText,i=s.querySelector(this.selectors.stockProblem.description).innerText;t.push({name:e,variant:i})}return t}_onLoad(e){try{switch(this._triggerEvent("load"),this.currentStep){case this.Steps.INFORMATION:this._triggerEvent("load:information");break;case this.Steps.SHIPPING:{let e=this._getSelectionMethods("shipping");this._triggerEvent("load:shipping",{shippingMethods:e});break}case this.Steps.PAYMENT:{let e=this._getSelectionMethods("payment");this._triggerEvent("load:payment",{paymentMethods:e});break}case this.Steps.PROCESSING:this._triggerEvent("load:processing");break;case this.Steps.THANKYOU:this._triggerEvent("load:thankyou");break;case this.Steps.ORDERSTATUS:this._triggerEvent("load:orderstatus");break;case this.Steps.STOCK_PROBLEMS:var t=this._getStockProblemList();this._triggerEvent("load:stockproblems",{stockProblemList:t})}}catch(t){this._triggerEvent("error",{step:this.currentStep,event:e,error:t})}}_fieldCreated(e){let t=e.detail,s=t.querySelector(this.selectors.fields),i=Object.prototype.hasOwnProperty.call(this.fields,s.id);this.fields&&!i&&(this.fields[s.id]=t)}_fieldRemoved(e){let t=e.detail.querySelector(this.selectors.fields),s=Object.prototype.hasOwnProperty.call(this.fields,t.id);this.fields&&s&&delete this.fields[t.id]}on(e,t){document.addEventListener("checkout:"+e,t,!1)}}export default Checkout;